#!/bin/dash

# pfilemnt: Click image files to mount & unmount
# by: Terry Becker aka: SunBurnt

# https://github.com/bkauler/woofq/blob/main/easyos/easy-code/rootfs-skeleton/usr/bin/filemnt

# Re-write by gumanzoy https://github.com/PocketHandyBox
# Renamed from filemnt to pfilemnt
# Replace rox with xdg-open
# Disable encrypted save-files
# Use notify-send, remove gtkdialog-splash, pupdialog, pupmessage
# Re-write, remove mount -t $Type option
# Re-write, support non-root user by pkexec

if [ $(id -u) -ne 0 ] && [ -z `which pkexec` ]; then
	echo "pkexec is not installed. This script should be run as root"
	exit 1
fi

if [ ! -f "$1" ]; then
	echo "No regular file: $1"
	exit 1
fi

FILEPATH="`realpath "$1"`"
FILENAME="`basename "$FILEPATH"`"

# File path /mnt/sda1/pocket-handybox_12_25_0008_vtgrub2.iso becomes
# mount path /mnt/+mnt+sda1+pocket-handybox_12_25_0008_vtgrub2.iso
MOUNTPATH='/mnt/'"`echo "$FILEPATH" | sed 's#/#+#g'`"

do_mount() {
if [ $(id -u) -ne 0 ]; then
	pkexec pfilemnt "$FILEPATH" mount
	return $?
else
	mkdir -p "$MOUNTPATH"
	mount -o loop "$FILEPATH" "$MOUNTPATH"
	Err=$?
	[ $Err -ne 0 ] && rmdir "$MOUNTPATH" 2> /dev/null
	return $Err
fi
}

do_umount() {
if [ $(id -u) -ne 0 ]; then
	pkexec pfilemnt "$FILEPATH" umount
	return $?
else
	mount | grep -q "$MOUNTPATH" | grep -q rw && sync
	umount "$MOUNTPATH"
	Err=$?
	mount | grep -q "$MOUNTPATH" && sync
	[ $Err -eq 0 ] && rmdir "$MOUNTPATH" 2> /dev/null
	return $Err
fi
}

if [ "$2" = mount ]; then
	[ $(id -u) -ne 0 ] && exit 1
	PATH="/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin"
	do_mount
	exit $?
elif [ "$2" = umount ]; then
	[ $(id -u) -ne 0 ] && exit 1
	PATH="/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin"
	do_umount
	exit $?
fi

notify_send() {
notify-send --app-name=pfilemnt --icon=system-file-manager "$@"
}

if mount | grep -q "$MOUNTPATH"; then # file mounted, unmount it
	if do_umount; then notify_send -t 3000 "Unmount" "\'$FILENAME\'"
	else notify_send "Failed to unmount" "\'$FILEPATH\'"
	fi
else # file not mounted
	if do_mount; then xdg-open "$MOUNTPATH" # mount good, run xdg-open
	notify_send -t 6000 "Mount succes" "Click \'$FILENAME\' icon again to unmount it"
	else notify_send "Failed to mount" "\'$FILENAME\'"
	fi
fi
